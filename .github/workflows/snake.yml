name: snake

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Generate snake SVG
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            dist/snake.svg?palette=github-dark

      - name: Generate trophy SVG
        run: |
          mkdir -p dist
          if ! curl -fsSL --retry 5 --retry-all-errors --retry-delay 2 -H "User-Agent: github-actions" \
              "https://github-profile-trophy.vercel.app/?username=${{ github.repository_owner }}&theme=algolia&no-frame=true&no-bg=true&row=1&column=7" \
              -o dist/trophy.svg; then
            cat > dist/trophy.svg <<'SVG'
            <svg xmlns="http://www.w3.org/2000/svg" width="900" height="140" viewBox="0 0 900 140" role="img" aria-label="Trophies placeholder">
              <rect width="900" height="140" rx="14" fill="#0b1220"/>
              <g fill="#e5e7eb" font-family="-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif" font-size="16">
                <text x="28" y="58" font-size="22" font-weight="700">Trophies</text>
                <text x="28" y="92">占位图：trophy 服务暂时不可用，稍后重试 workflow “snake” 会自动生成真实 trophy.svg</text>
              </g>
              <g fill="#94a3b8" font-family="-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif" font-size="13">
                <text x="28" y="118">如果频繁失败：可能是限流（429）或临时故障。</text>
              </g>
            </svg>
SVG
          fi

      - name: Push to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
